<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title></title>
<script type="text/javascript" src="_Canvas.js"></script>
<script type="text/javascript" src="_ColorWin.js"></script>
<script type="text/javascript" src="_DefCharInfo.js"></script>
<script type="text/javascript" src="_DefCharInfoLarge.js"></script>
<script type="text/javascript" src="_EasyClip.js"></script>
<script type="text/javascript" src="../clip.js"></script>
<script type="text/javascript">
var _clip;

function main(){
	_clip = new _EasyClip();
	_clip.commandGWorld( 256, 256 );
	_clip.commandGColor( 252 );
	_clip.procScript( [
		"func text3d_x",
		"    :ans FALSE",
		"    :sprint @@s @0",
		"    :gtext @@s (gx @1 - 4) (gy @2 + 9) @3",
		"endfunc",
		"func text3d_y",
		"    :ans FALSE",
		"    :sprint @@s @0",
		"    :gtext @@s (gx @1 + 3) (gy @2 + 7) @3",
		"endfunc",
		"func text3d_z",
		"    :ans FALSE",
		"    :sprint @@s (@0 * @4)",
		"    :gtext @@s 0 (gheight + 8) 0 # 画面外に描画",
		"    :gtext @@s (gx @1 - gcx) (gy @2 + 3) @3",
		"endfunc",
		"func window3d l b r t x y z every z_scale",
		"    :ans FALSE",
		"    :window l b r t",
		"    :gclear \\xFF",
		"    for @i = [-]x, @j = 1; @i >= l; @i -= x, @j++",
		"        if (@j % every) == 0",
		"            text3d_x @i @i 0 \\xF7",
		"        endif",
		"    next",
		"    for @i = x, @j = 1; @i <= r; @i += x, @j++",
		"        if (@j % every) == 0",
		"            text3d_x @i @i 0 \\xF7",
		"        endif",
		"    next",
		"    for @i = [-]z, @j = 1; @i >= b; @i -= z, @j++",
		"        if (@j % every) == 0",
		"            text3d_z @i 0 @i \\xF7 z_scale",
		"        endif",
		"    next",
		"    for @i = z, @j = 1; @i <= t; @i += z, @j++",
		"        if (@j % every) == 0",
		"            text3d_z @i 0 @i \\xF7 z_scale",
		"        endif",
		"    next",
		"    for @i = [-]y, @j = 1; ; @i -= y, @j++",
		"        if (@j % every) == 0",
		"            text3d_y @i (@i * \\-0.5) (@i * \\-0.5) \\xF7",
		"            if gcx < 0 || gcx >= gwidth || gcy < 0 || gcy >= gheight",
		"                break",
		"            endif",
		"        endif",
		"    next",
		"    for @i = y, @j = 1; ; @i += y, @j++",
		"        if (@j % every) == 0",
		"            text3d_y @i (@i * \\-0.5) (@i * \\-0.5) \\xF7",
		"            if gcx < 0 || gcx >= gwidth || gcy < 0 || gcy >= gheight",
		"                break",
		"            endif",
		"        endif",
		"    next",
		"    :wline l 0 r 0 \\xF7",
		"    :wline 0 b 0 t \\xF7",
		"    if b < 0 && t > 0",
		"        :wline b b 0 0 \\xF7",
		"        :wline 0 0 t t \\xF7",
		"    else",
		"        :wline b b t t \\xF7",
		"    endif",
		"    :gtext [\"0] (gx 0 + 2) (gy 0 + 9) \\xF7",
		"endfunc",
		"func proj2d &x2 &z2 x1 y1 z1",
		"    :ans FALSE",
		"    y1 *= 0.5",
		"    x2 = x1 + y1",
		"    z2 = z1 + y1",
		"endfunc",
		"func draw3d x1 y1 z1 x2 y2 z2 color",
		"    :ans FALSE",
		"    proj2d x1 z1 x1 y1 z1",
		"    proj2d x2 z2 x2 y2 z2",
		"    :wline x1 z1 x2 z2 color",
		"endfunc",
		"func plot3d expr[] x1 x2 x_step y1 y2 y_step z_step every z_scale",
		"    :ans FALSE",
		"    if x1 > x2; @t = x1; x1 = x2; x2 = @t; endif",
		"    if y1 > y2; @t = y1; y1 = y2; y2 = @t; endif",
		"    if x_step < 0; x_step = abs x_step; endif",
		"    if y_step < 0; y_step = abs y_step; endif",
		"    if z_step < 0; z_step = abs z_step; endif",
		"    every = int every; if every == 0; every = 1; elif every < 0; every = abs every; endif",
		"    if z_scale == 0; z_scale = 1; elif z_scale < 0; z_scale = abs z_scale; endif",
		"    :global x y",
		"    for y = y1, @i = 0; y <= y2; y += y_step, @i++",
		"        for x = x1, @j = 0; x <= x2; x += x_step, @j++",
		"            @@a @i @j 0 = x",
		"            @@a @i @j 1 = y",
		"            @@a @i @j 2 = eval expr * z_scale",
		"        next",
		"        @X = @j",
		"    next",
		"    @Y = @i",
		"    @l = @b = @r = @t = 0",
		"    @f = TRUE # 初回フラグ",
		"    for @i = 0; @i < @Y; @i++",
		"        for @j = 0; @j < @X; @j++",
		"            proj2d @x @z (@@a @i @j 0) (@@a @i @j 1) (@@a @i @j 2)",
		"            if @f",
		"                @f = FALSE",
		"                @l = @x",
		"                @r = @x",
		"                @b = @z",
		"                @t = @z",
		"            else",
		"                if @x < @l; @l = @x; endif",
		"                if @x > @r; @r = @x; endif",
		"                if @z < @b; @b = @z; endif",
		"                if @z > @t; @t = @z; endif",
		"            endif",
		"        next",
		"    next",
		"    # 正方形領域にする",
		"    if @r - @l > @t - @b",
		"        @s = ((@r - @l) - (@t - @b)) / 2",
		"        @t += @s",
		"        @b -= @s",
		"    else",
		"        @s = ((@t - @b) - (@r - @l)) / 2",
		"        @r += @s",
		"        @l -= @s",
		"    endif",
		"    @c = gcolor # 現在色を取得しておく",
		"    window3d @l @b @r @t x_step y_step z_step every z_scale",
		"    if x2 - x1 >= y2 - y1",
		"        for @i = 0; @i < @Y; @i++",
		"            for @j = 1; @j < @X; @j++",
		"                @k = @j - 1",
		"                draw3d (@@a @i @k 0) (@@a @i @k 1) (@@a @i @k 2) (@@a @i @j 0) (@@a @i @j 1) (@@a @i @j 2) @c",
		"            next",
		"        next",
		"    endif",
		"    if x2 - x1 <= y2 - y1",
		"        for @i = 1; @i < @Y; @i++",
		"            @k = @i - 1",
		"            for @j = 0; @j < @X; @j++",
		"                draw3d (@@a @k @j 0) (@@a @k @j 1) (@@a @k @j 2) (@@a @i @j 0) (@@a @i @j 1) (@@a @i @j 2) @c",
		"            next",
		"        next",
		"    endif",
		"    :gcolor @c # 現在色を戻す",
		"endfunc"
	] );
	_clip.procLine( "plot3d [\"exp([-\\](x*x+y*y] \\-2 2 0.2 \\-2 2 0.2 0.2 5 1" );
	_clip.updateCanvas();
}

function doFuncGColor( rgb ){
	var i, j;
	var r = (rgb & 0xFF0000) >> 16;
	var g = (rgb & 0x00FF00) >> 8;
	var b =  rgb & 0x0000FF;
	var rr, gg, bb, tmp;
	var d = 766/*255*3+1*/;
	for( i = 0, j = 0; i < 256; i++ ){
		rr =  COLOR_WIN[i] & 0x0000FF;
		gg = (COLOR_WIN[i] & 0x00FF00) >> 8;
		bb = (COLOR_WIN[i] & 0xFF0000) >> 16;
		tmp = Math.abs( rr - r ) + Math.abs( gg - g ) + Math.abs( bb - b );
		if( tmp < d ){
			j = i;
			d = tmp;
		}
	}
	return j;
}
function doFuncGColor24( index ){
	return ((COLOR_WIN[index] & 0x0000FF) << 16) + (COLOR_WIN[index] & 0x00FF00) + ((COLOR_WIN[index] & 0xFF0000) >> 16);
}

function doCommandGWorld( gWorld, width, height ){
	if( _clip.setCanvas( "canvas0" ) ){
		// 文字情報を登録する
		regGWorldDefCharInfo( 0 );
		regGWorldDefCharInfoLarge( 1 );
	}

	var div = document.getElementById( "div0" );
	div.style.width  = "" + width  + "px";
	div.style.height = "" + height + "px";

	_clip._canvas.element().setAttribute( "width" , "" + width  );
	_clip._canvas.element().setAttribute( "height", "" + height );

	gWorld.create( width, height, true );
}
function doCommandGColor( color, rgb ){
	COLOR_WIN[color] = ((rgb & 0x0000FF) << 16) + (rgb & 0x00FF00) + ((rgb & 0xFF0000) >> 16);
}
function doCommandGPut24End(){
	var bgrColor = COLOR_WIN[_clip._proc.gWorld().color()];
	_clip._canvas.setColor( bgrColor & 0x0000FF, (bgrColor & 0x00FF00) >> 8, (bgrColor & 0xFF0000) >> 16 );
}

function canvasPut( canvas, x, y, index ){
	var bgrColor = COLOR_WIN[index];
	canvas.setColor( bgrColor & 0x0000FF, (bgrColor & 0x00FF00) >> 8, (bgrColor & 0xFF0000) >> 16 );
	canvas.put( x, y );
}

function canvasSave(){
	var data = _clip._canvas.element().toDataURL( "image/png" ).replace( "image/png", "image/octet-stream" );
	window.open( data, "save" );
}
</script>
</head>
<body onload="main()">
<div id="div0" style="width:1px; height:1px"><canvas id="canvas0" width="1" height="1"></canvas></div>
<hr style="border:0; margin:0; height:10px">
<form action="javascript:canvasSave()"><button type="submit">ダウンロード</button></form>
</body>
</html>
